<html>

  <head>
    <title>Quantum</title>
    <meta http-equiv='content-type' content='text/html; charset=ISO-8859-1'>
    <link rel='shortcut icon' href='favicon.ico' type='image/x-icon' />
    <link rel='stylesheet' href='style.css' type='text/css' />

    <script src='util/framerate.js'></script>
    <script src='util/light.js'></script>
    <script src='util/physics.js'></script>
    <script src='util/util.js'></script>
    <script src='util/vector.js'></script>
    <script src='util/key_code.js'></script>
    <script src='input/hero_listener.js'></script>
    <script src='population/thing.js'></script>
    <script src='population/box.js'></script>
    <script src='population/dumb_crate.js'></script>
    <script src='population/sun.js'></script>
    <script src='population/shelf.js'></script>
    <script src='population/hero.js'></script>
    <script src='population/pane.js'></script>
    <script src='gl/gl.js'></script>
    <script src='gl-matrix/common.js'></script>
    <script src='gl-matrix/mat3.js'></script>
    <script src='gl-matrix/mat4.js'></script>
    <script src='gl-matrix/vec2.js'></script>
    <script src='gl-matrix/vec3.js'></script>
    <script src='gl-matrix/vec4.js'></script>
    <script src='gl/shader_program.js'></script>
    <script src='gl/webgl-utils.js'></script>
    <script src='media/texture.js'></script>
    <script src='media/sound_manager.js'></script>
    <script src='effects/double_explosion.js'></script>
    <script src='effects/image_cross.js'></script>
    <script src='ui/camera.js'></script>
    <script src='world.js'></script>


    <script id="fragment-shader" type="x-shader/x-fragment">
      precision mediump float;

      varying vec2 vTextureCoord;
      varying vec3 vTransformedNormal;
      varying vec4 vPosition;
      varying vec4 vLightPosition;
      varying vec4 vColor;

      uniform bool uUseLighting;
      uniform bool uUseTexture;

      uniform vec3 uAmbientColor;

      uniform vec3 uPointLightingColor;

      uniform sampler2D uSampler;


      void main(void) {
        vec3 lightWeighting;
        if (!uUseLighting) {
          lightWeighting = vec3(1.0, 1.0, 1.0);
        } else {
          vec3 lightDirection = 
              normalize(vLightPosition.xyz - vPosition.xyz);

          float directionalLightWeighting = max(
              dot(
                  normalize(vTransformedNormal),
                  lightDirection
              ), 0.0);
          lightWeighting = uAmbientColor + uPointLightingColor * directionalLightWeighting;
        }

        vec4 fragmentColor;
        if (uUseTexture) {
          fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        } else {
          fragmentColor = vColor;
        }
        gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);
      }
    </script>

    <script id="vertex-shader" type="x-shader/x-vertex">
      precision mediump float;

      attribute vec3 aVertexPosition;
      attribute vec3 aVertexNormal;
      attribute vec2 aTextureCoord;

      uniform mat4 uModelMatrix;
      uniform mat4 uViewMatrix;
      uniform mat4 uPerspectiveMatrix;
      uniform mat3 uNormalMatrix;
      uniform vec4 uColor; 
      uniform vec3 uPointLightingLocation;

      varying vec2 vTextureCoord;
      varying vec3 vTransformedNormal;
      varying vec4 vPosition;
      varying vec4 vLightPosition;
      varying vec4 vColor;


      void main(void) {

        vPosition = uModelMatrix * vec4(aVertexPosition, 1.0);
        vLightPosition = uModelMatrix * vec4(uPointLightingLocation, 1.0);
        gl_Position = uPerspectiveMatrix * uViewMatrix * vPosition;
        vTextureCoord = aTextureCoord;
        vTransformedNormal = uNormalMatrix * aVertexNormal;
        vColor = uColor;
      }
    </script>


    <script type="text/javascript">

      var gl;
      var shaderProgram;
      var framerate;

      var world;
      var camera;

      function drawScene() {
        gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);

        gl.clearColor(
            world.clearColorRgba[0],
            world.clearColorRgba[1],
            world.clearColorRgba[2],
            1.0);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);


        mat4.perspective(gl.pMatrix,
            PI/4, gl.viewportWidth/gl.viewportHeight,
            0.01, 30.0);

        gl.useProgram(shaderProgram);

        mat4.identity(gl.modelMatrix);

        world.draw();
      }

      function animate() {
        var timeNow = new Date().getTime();
        if (framerate.lastTime != 0) {
          var elapsed = timeNow - framerate.lastTime;
          if (elapsed < 100) {
            var dt = elapsed/1000;
            world.advance(dt);
          }
          framerate.snapshot();
        }
        framerate.lastTime = timeNow;

      }


      function tick() {
        requestAnimFrame(tick);
        drawScene();
        animate();
      }


      function webGLStart() {
        var glCanvas = document.getElementById("gl-canvas");
        gl = GL.createGL(glCanvas);
        shaderProgram = ShaderProgram.createShaderProgram();
        Textures.initTextures();

        window.addEventListener('resize',
            util.partial(resize, glCanvas, gl));
        resize(glCanvas, gl);

        Textures.initTextures();

        framerate = new Framerate('framerate');
        var gameDiv = document.getElementById('game-div');
        heroListener = new HeroListener(gameDiv);
        heroListener.attachEvents();

        world = new World();
        world.populate();

        tick();
      }

      function resize(glCanvas, gl) {
        glCanvas.width = window.innerWidth;
        glCanvas.height = window.innerHeight;
        gl.viewportWidth = window.innerWidth;
        gl.viewportHeight = window.innerHeight;
      };

    </script>
  </head>

  <body onload="webGLStart();">
    <div id='game-div'>
      <canvas id='gl-canvas'></canvas>
    </div>
  </body>
</html>
